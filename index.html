<!DOCTYPE html>
<html>
<head>
	<xmeta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<link href="default.css" rel="stylesheet" type="text/css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<!--<script src="../socket.io/socket.io.js"></xscript>-->
	<script src="https://cdn.socket.io/socket.io-1.1.0.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?libraries=visualization&sensor=false" type="text/javascript"></script>

	<script>
	function getQueryParams(qs) {
		qs = qs.split("+").join(" ");
		var params = {},
			tokens,
			re = /[?&]?([^=]+)=([^&]*)/g;

		while (tokens = re.exec(qs)) {
			params[decodeURIComponent(tokens[1])]
				= decodeURIComponent(tokens[2]);
		}

		return params;
	}
	</script>

</head>
<body onload="initialize()">
	<div id="map_canvas"></div>
	<div id="clients"></div>
	<div id="data"></div>
</body>
</html>

<script>
	var map;
	var events = new google.maps.MVCArray();
	var heatmap = new google.maps.visualization.HeatmapLayer({
		data: events,
		radius: 10
	});
	
	var markersArray = {};
	var $_GET = getQueryParams(document.location.search);
	var filter = {};
	if ($_GET['site_id']) {
		filter.site = $_GET['siteid'];
	} else if ($_GET['post_id']) {
		filter.post = $_GET['post_id'];
	}

	function initialize() {
		var mapOptions = {
			panControl: false,
			streetViewControl: false,
			mapTypeControl: false,
			zoomControlOptions: {
				style: google.maps.ZoomControlStyle.SMALL,
				position: google.maps.ControlPosition.RIGHT_TOP
			},
			zoom: 4,
			center: new google.maps.LatLng(37.09024, -95.712891),
			mapTypeId: google.maps.MapTypeId.TERRAIN
		};
		map =  new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
		heatmap.setMap(map);
	}

	var traffic = io.connect('ws://127.0.0.1:7123');

	traffic.on('connected', function (data) {
		$('#clients').text(data.num + " viewers");
	});

	traffic.on('serve:/', function (data) {
		console.log(data);
		//if (filter && filter != data.id) {
		//	return;
		//}
		time = new Date();
		epoch = time.getTime();
		var randomnumber = epoch + "" + Math.floor(Math.random()*50000);
		var icon = "";
		var title = "";

		switch(data.site_id) {
			case 12345:
				icon = "http://assets.tedcdn.com/favicon.ico";
				title = "TED";
				break;
			default:
				icon = "blurdot.png";
				title = " ";
		}

		$('#data').html("<div>"+title+"("+data.id+")</div>");

		var point = new google.maps.LatLng(data.geo.lat, data.geo.long);
		console.log("Creating");
		events.push(point);
		
		setTimeout(function(){
			events.removeAt(0);
		}, 5000);
		
		var marker = new google.maps.Marker({
			position: point,
			map: map,
			icon: icon,
			title: title
		});
		
		// Should I do a push() and slice/removeAt(0)?
		markersArray[randomnumber] = marker;
		setTimeout(function(){
			markersArray[randomnumber].setMap(null); 
			delete markersArray[randomnumber];
		},200);
	});

	/*
	$.ajax({
	    contentType: 'application/json',
	    data: '{"channel":"serve","data":{"id":12,"geo":{"latitude":"37.7833","longitude":"-122.4167"}}}',
	    dataType: 'json',
	    processData: false,
	    type: 'POST',
	    url: 'http://127.0.0.1:8123/'
	});
	*/
</script>

